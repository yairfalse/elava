# OpenTelemetry Collector Configuration - Datadog SaaS
# Send all Elava telemetry to Datadog (all-in-one observability platform)

receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

processors:
  # Memory limiter
  memory_limiter:
    check_interval: 1s
    limit_mib: 1024
    spike_limit_mib: 256

  # Batch for efficiency
  batch:
    timeout: 10s
    send_batch_size: 1024

  # Add resource attributes
  resource:
    attributes:
      - key: service.name
        value: elava
        action: upsert
      - key: deployment.environment
        value: ${ENVIRONMENT:-production}
        action: upsert

  # Auto-detect cloud/container metadata
  resourcedetection:
    detectors: [env, system, docker, ec2, gcp, azure, ecs, eks]
    timeout: 5s

exporters:
  # Datadog exporter - sends all signals to Datadog
  datadog:
    # API configuration
    api:
      key: ${DD_API_KEY}
      site: ${DD_SITE:-datadoghq.com}  # Use datadoghq.eu for EU, etc.

    # Hostname configuration
    hostname: ${HOSTNAME:-elava}

    # Traces configuration
    traces:
      span_name_as_resource_name: true
      span_name_remappings:
        "reconciler.reconcile": "elava.reconcile"
        "reconciler.observe": "elava.observe"
        "reconciler.detect": "elava.detect"
        "reconciler.decide": "elava.decide"

    # Metrics configuration
    metrics:
      # Map OTEL metric names to Datadog format
      histograms:
        mode: distributions
        send_aggregation_metrics: true

    # Host metadata
    host_metadata:
      enabled: true
      hostname_source: config_or_system

  # Debug exporter (optional - disable in production)
  # debug:
  #   verbosity: basic

extensions:
  health_check:
    endpoint: 0.0.0.0:13133

service:
  extensions: [health_check]

  pipelines:
    # Traces to Datadog
    traces:
      receivers: [otlp]
      processors: [memory_limiter, resourcedetection, resource, batch]
      exporters: [datadog]

    # Metrics to Datadog
    metrics:
      receivers: [otlp]
      processors: [memory_limiter, resourcedetection, resource, batch]
      exporters: [datadog]

    # Logs to Datadog
    logs:
      receivers: [otlp]
      processors: [memory_limiter, resourcedetection, resource, batch]
      exporters: [datadog]

  telemetry:
    logs:
      level: info
    metrics:
      address: 0.0.0.0:8888
